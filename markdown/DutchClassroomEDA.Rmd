---
title: "network_eda"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)

library(igraph)
library(tidygraph)
library(zeallot)

library(lsmdn)
```

```{r hairballs}
convert_to_tidy_graph <- function(dutch, t) {
    sex_colors <- c(adjustcolor('darkorange', alpha.f = 0.9), adjustcolor('steelblue', 0.9))
    graph_tbl <- igraph::graph_from_adjacency_matrix(dutch$Y[, , t]) %>% 
        igraph::simplify() %>% 
        as_tbl_graph() %>% 
        activate(nodes) %>% 
        mutate(sex = dutch$demographics$sex) %>% 
        mutate(age = dutch$demographics$age) %>% 
        mutate(ethnicity = dutch$demographics$ethnicity) %>% 
        mutate(religion = dutch$demographics$religion) %>% 
        mutate(missing = is.na(dutch$Y[,3,t])) %>% 
        mutate(label = 1:25) %>% 
        #arrange(sex) %>% 
        # plotting attributes
        mutate(color = ifelse(sex == 'boy', sex_colors[2], sex_colors[1])) %>% 
        mutate(shape = ifelse(ethnicity == 'dutch', 'circle', 'square')) %>% 
        mutate(label.cex = 0.5) %>%
        mutate(label.color = 'white') %>% 
        mutate(frame.color = ifelse(missing, 'black', 'white')) %>% 
        activate(edges) %>% 
        mutate(arrow.size = 0.3) 
    
    graph_tbl
}
```

```{r hairballs}
par(mfrow=c(2, 2), mar=c(1, 1, 1, 1))

graph <- convert_to_tidy_graph(dutch, t = 4)
l <- layout_with_fr(graph)

for(t in 1:4) {
    graph <- convert_to_tidy_graph(dutch, t = t) 
    plot(graph)#, layout = l)
    text(x = -1.5, y = 1, paste0("t = ", t))
}
```

```{r circle}
par(mfrow=c(2, 2), mar=c(0, 0, 0, 0))

graph <- convert_to_tidy_graph(dutch, t = 1)
l <- layout_in_circle(graph)

for(t in 1:4) {
    graph <- convert_to_tidy_graph(dutch, t = t) #%>% 
        #activate(nodes) %>% 
        #arrange(sex)
    
    plot(graph, layout = l)
    text(x = -1.5, y = 1, paste0("t = ", t))
}
```
```{r load_model}
# model <- lsmdn(dutch$Y, num_samples = 500000)
model <- readRDS('dutch.model')
```

```{r plot_latent_positions}
xl <- c(1.15 * min(model$X[,1,]), 1.15 * max(model$X[,1,]))
yl <- c(1.15 * min(model$X[,2,]), 1.15 * max(model$X[,2,]))
lims <- range(c(xl , yl))

num_time_steps <- dim(model$X)[3]
num_nodes <- dim(model$X)[1]
color_assesment = rep(1, num_nodes)
color_assesment[dutch$demographics$assessment == 4] = 2 
color_assesment[dutch$demographics$assessment == 8] = 3



#for(t in 13:num_time_steps) {
#    arrows(model$X[,1,t-1], model$X[,2,t-1],
#           model$X[,1,t], model$X[,2,t],
#           length=0.1)
#}

t = 14
xl <- c(1.15 * min(model$X[,1,t]), 1.15 * max(model$X[,1,t]))
yl <- c(1.15 * min(model$X[,2,t]), 1.15 * max(model$X[,2,t]))
lims <- range(c(xl , yl))
plot(1, type="n", xlab="", ylab="", xlim=lims, ylim=lims, xaxt = 'n', yaxt = 'n', frame.plot = FALSE)


alpha = 0.7
points(model$X[, 1, t], model$X[, 2, t], pch = 21,
       cex = 2, xlim = lims, ylim = lims,
       bg = adjustcolor('darkorange', alpha.f = alpha))
     #pch = ifelse(dutch$demographics$ethnicity == 'dutch', 21, 22), 
     #cex = 2, xlim = lims, ylim = lims,
     #bg = ifelse(
     #    dutch$demographics$sex == 'girl', 
     #    adjustcolor('darkorange', alpha.f = alpha),
     #    adjustcolor('steelblue', alpha)
     #),
     #col = c('white', 'red', 'black')[color_assesment])
text(model$X[, 1, t], model$X[, 2, t], labels = 1:nrow(model$X[,1,]), col = 'white', cex = 0.4)

```

```{r synthetic_data}
n_iter <- 5

models <- list()
datasets <- list()
for(i in 1:n_iter) {
    data <- synthetic_network(num_nodes = 25, num_time_steps = 5, seed = i * 7)
    model <- lsmdn(data$Y)
    datasets[[i]] <- data
    models[[i]] <- models
}
```
